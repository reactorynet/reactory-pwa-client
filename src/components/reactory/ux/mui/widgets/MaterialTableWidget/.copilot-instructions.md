# MaterialTableWidget Copilot Instructions

Instructions for AI assistants (GitHub Copilot, Cursor, Claude, etc.) when working with the MaterialTableWidget module.

## Overview

This module contains the MaterialTableWidget - a data table component for the Reactory framework. It includes the main widget, sub-components (SearchBar, QuickFilters, AdvancedFilterPanel), and custom hooks.

## File Structure

```
MaterialTableWidget/
├── MaterialTableWidget.tsx       # Main widget (~2000 lines)
├── index.ts                      # Exports
├── __tests__/                    # Main component tests
│   ├── MaterialTableWidget.test.tsx  # 33 tests
│   └── README.md
├── components/                   # Sub-components
│   ├── AdvancedFilterPanel.tsx   # Advanced filter drawer
│   ├── ColumnHeader.tsx          # Enhanced column header renderer
│   ├── QuickFilters.tsx          # Quick filter buttons/chips
│   ├── SearchBar.tsx             # Debounced search input
│   ├── index.ts
│   └── __tests__/                # Component tests
│       ├── SearchBar.test.tsx        # 17 tests
│       ├── QuickFilters.test.tsx     # 28 tests
│       ├── AdvancedFilterPanel.test.tsx  # 31 tests
│       ├── ColumnHeader.test.tsx     # 27 tests
│       └── README.md
├── hooks/                        # Custom React hooks
│   ├── useAdvancedFilters.ts     # Advanced filter state management
│   ├── useComponentLoader.ts     # Component loading with efficient polling
│   ├── useDebounce.ts            # Debounced values and search
│   ├── useQuickFilters.ts        # Quick filter state management
│   ├── index.ts
│   └── __tests__/                # Hook tests
│       ├── useDebounce.test.ts       # 21 tests
│       ├── useQuickFilters.test.ts   # 28 tests
│       ├── useAdvancedFilters.test.ts  # 30 tests
│       └── README.md
└── docs/                         # Documentation
    ├── README.md
    ├── ARCHITECTURE.md
    ├── API_REFERENCE.md
    ├── USAGE_EXAMPLES.md
    └── TESTING.md
```

**Total Test Coverage: 215 tests**

---

## TDD Guidelines

### CRITICAL: Test-First Development

When making ANY changes to this module, follow TDD strictly:

1. **ALWAYS write tests FIRST** before implementing features or fixes
2. **Run tests after each change** to verify behavior
3. **Never skip tests** for "simple" changes

### TDD Workflow

```
1. Write failing test → 2. Implement minimum code → 3. Test passes → 4. Refactor → 5. Repeat
```

### Before Making Changes

1. Check if tests exist for the area you're modifying
2. If tests don't exist, create them first
3. Run existing tests to establish baseline: `yarn test --testPathPattern="MaterialTableWidget"`

### Test Creation Pattern

For any new feature or bug fix:

```typescript
// 1. Create test file if it doesn't exist
// hooks/__tests__/useNewFeature.test.ts

import { renderHook, act } from '@testing-library/react';
import { useNewFeature } from '../useNewFeature';

describe('useNewFeature', () => {
  // 2. Write test for expected behavior
  it('should [describe expected behavior]', () => {
    // Arrange
    const { result } = renderHook(() => useNewFeature());
    
    // Act
    act(() => {
      result.current.someAction();
    });
    
    // Assert
    expect(result.current.someValue).toBe(expectedValue);
  });
});
```

---

## Running Tests

### Essential Commands

```bash
# Run all MaterialTableWidget tests
yarn test --testPathPattern="MaterialTableWidget"

# Run specific test file
yarn test hooks/__tests__/useQuickFilters.test.ts

# Run tests in watch mode (for development)
yarn test --watch --testPathPattern="MaterialTableWidget"

# Run with coverage report
yarn test --coverage --testPathPattern="MaterialTableWidget"

# Run tests matching a specific name
yarn test --testNamePattern="should filter data"
```

### Test Output Interpretation

- ✓ Green checkmark = test passed
- ✗ Red X = test failed (shows expected vs actual)
- ○ Circle = test skipped

### Debugging Failed Tests

```bash
# Verbose output
yarn test --verbose --testPathPattern="MaterialTableWidget"

# Run single test with debugging
yarn test --testNamePattern="exact test name" --verbose
```

---

## Code Conventions

### TypeScript

- Use strict typing, avoid `any` where possible
- Export interfaces and types from hook files
- Use generics for reusable components

### React Patterns

```typescript
// Hooks: use `useCallback` for functions passed to children
const handleClick = useCallback(() => {
  // implementation
}, [dependency]);

// State updates: use functional form for state depending on previous
setFilters((prev) => [...prev, newFilter]);

// Effects: always specify dependencies
useEffect(() => {
  // effect
}, [specificDependency]);
```

### Naming Conventions

| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase | `QuickFilters` |
| Hooks | camelCase with `use` prefix | `useQuickFilters` |
| Props interfaces | PascalCase with `Props` suffix | `QuickFiltersProps` |
| Event handlers | `handle` + event | `handleFilterChange` |
| Boolean props | `is` or `has` prefix | `isActive`, `hasFilters` |

---

## Component Guidelines

### Main Widget (MaterialTableWidget.tsx)

This is a complex component with many features:
- Remote and local data handling
- Row selection and expansion
- Pagination
- Actions and mutations
- Custom renderers

When modifying:
1. Understand the feature you're changing by reading related code
2. Check how state flows through the component
3. Test changes with both remote and local data modes

### Sub-Components

#### SearchBar
- Uses `useDebouncedSearch` hook internally
- Handles loading state display
- Supports clear and manual search buttons

#### QuickFilters
- Supports both button and chip variants
- Uses `useQuickFilters` hook
- Handles single and multi-select modes

#### AdvancedFilterPanel
- Drawer-based UI
- Uses `useAdvancedFilters` hook
- Supports filter presets

### Hooks

#### useDebounce / useDebouncedSearch
- Generic debouncing utility
- Must clean up timers on unmount
- Test with `jest.useFakeTimers()`

#### useQuickFilters
- Manages quick filter state
- `applyFilters` filters data client-side
- Test all operators

#### useAdvancedFilters
- Complex filter state management
- Preset save/load functionality
- Test all filter operators

---

## Testing Patterns

### Hook Testing

```typescript
import { renderHook, act } from '@testing-library/react';

describe('useMyHook', () => {
  it('should handle state changes', () => {
    const { result } = renderHook(() => useMyHook());
    
    act(() => {
      result.current.updateState('newValue');
    });
    
    expect(result.current.state).toBe('newValue');
  });
});
```

### Component Testing

```typescript
import { render, screen, fireEvent } from '@testing-library/react';

describe('MyComponent', () => {
  it('should render and handle interactions', () => {
    const onAction = jest.fn();
    render(<MyComponent onAction={onAction} />);
    
    fireEvent.click(screen.getByRole('button'));
    
    expect(onAction).toHaveBeenCalled();
  });
});
```

### Async Testing

```typescript
import { waitFor } from '@testing-library/react';

it('should handle async operations', async () => {
  jest.useFakeTimers();
  
  const { result } = renderHook(() => useAsyncHook());
  
  act(() => {
    result.current.startAsync();
    jest.advanceTimersByTime(300);
  });
  
  await waitFor(() => {
    expect(result.current.isComplete).toBe(true);
  });
  
  jest.useRealTimers();
});
```

---

## Common Tasks

### Adding a New Filter Type

1. **Write test first:**
```typescript
// hooks/__tests__/useAdvancedFilters.test.ts
it('should apply new-operator filter', () => {
  const { result } = renderHook(() => useAdvancedFilters({ fields }));
  
  act(() => {
    result.current.setFilter('field', 'value', 'new-operator');
  });
  
  const filtered = result.current.applyFilters(testData);
  expect(filtered).toHaveLength(expectedCount);
});
```

2. **Implement in hook:**
```typescript
// hooks/useAdvancedFilters.ts
case 'new-operator':
  return /* filter logic */;
```

3. **Verify test passes:**
```bash
yarn test --testNamePattern="should apply new-operator"
```

### Adding a New Column Type

1. **Write test for column rendering**
2. **Add column type handling in MaterialTableWidget**
3. **Update API_REFERENCE.md**
4. **Add usage example in USAGE_EXAMPLES.md**

### Fixing a Bug

1. **Write test that reproduces the bug (should fail)**
2. **Implement fix**
3. **Verify test passes**
4. **Check no regression in existing tests**

---

## Documentation Updates

When making changes, update relevant documentation:

| Change Type | Update |
|-------------|--------|
| New prop | API_REFERENCE.md |
| New feature | README.md, USAGE_EXAMPLES.md |
| Architecture change | ARCHITECTURE.md |
| New test pattern | TESTING.md |
| Breaking change | README.md (migration section) |

---

## Code Review Checklist

Before submitting changes, verify:

- [ ] All tests pass: `yarn test --testPathPattern="MaterialTableWidget"`
- [ ] New code has test coverage
- [ ] TypeScript compiles without errors
- [ ] No `any` types without justification
- [ ] Documentation updated if needed
- [ ] No console.log statements left
- [ ] Components are properly memoized if needed

---

## Emergency Reference

### Quick Test Commands

```bash
# All MaterialTableWidget tests (188 tests)
yarn test --testPathPattern="MaterialTableWidget"

# Main component tests only (33 tests)
yarn test --testPathPattern="MaterialTableWidget/__tests__/MaterialTableWidget.test"

# Hook tests only (79 tests)
yarn test --testPathPattern="MaterialTableWidget/hooks/__tests__"

# Component tests only (76 tests)
yarn test --testPathPattern="MaterialTableWidget/components/__tests__"

# Specific hook
yarn test useQuickFilters

# Specific component
yarn test QuickFilters

# Watch mode
yarn test --watch --testPathPattern="MaterialTableWidget"

# Coverage report
yarn test --coverage --testPathPattern="MaterialTableWidget"
```

### File Locations

| Need | File |
|------|------|
| Main widget | `MaterialTableWidget.tsx` |
| Main widget tests | `__tests__/MaterialTableWidget.test.tsx` |
| Hook tests | `hooks/__tests__/*.test.ts` |
| Component tests | `components/__tests__/*.test.tsx` |
| Type definitions | `hooks/*.ts` (exported interfaces) |
| API docs | `docs/API_REFERENCE.md` |

### Common Imports

```typescript
// Hook Testing (React 17 - use react-hooks package)
import { renderHook, act } from '@testing-library/react-hooks';

// Component Testing
import { render, screen, fireEvent, waitFor } from '@testing-library/react';

// Hooks
import { useQuickFilters, QuickFilterDefinition } from '../hooks';
import { useAdvancedFilters, AdvancedFilterField } from '../hooks';
import { useDebounce, useDebouncedSearch } from '../hooks';

// Components
import { SearchBar, QuickFilters, AdvancedFilterPanel } from '../components';
```

---

## Contact

For questions about this module, refer to:
- Documentation in `docs/` folder
- Existing test files for patterns
- Reactory framework documentation
